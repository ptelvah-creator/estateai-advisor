<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstateAI Advisor - Kenya's Smart Property Assistant</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha512-nFQhBjU6z0tCq7KfHkXpJg8m3nLZGcYR+eMvSsXaWVb9uEiOoNlDjT0QxQrPdJ3I3XJ8w4V0A=="
          crossorigin=""/>
    
    <style>
        :root {
            --primary: #2a9d8f;
            --secondary: #e9c46a;
            --dark: #264653;
            --light: #f4f1de;
            --danger: #e76f51;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: var(--light);
            color: var(--dark);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
            border-radius: 0 0 10px 10px;
            margin-bottom: 2rem;
        }
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        #chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f9f9f9;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
        }
        .user-message {
            background: var(--secondary);
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .bot-message {
            background: #e0e0e0;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        #chat-input {
            display: flex;
            padding: 10px;
            background: white;
            border-top: 1px solid #ddd;
        }
        #chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
        }
        #chat-input button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            cursor: pointer;
        }
        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .image-preview {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .image-preview img {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .products {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        .premium-badge {
            background: var(--secondary);
            color: var(--dark);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        footer {
            text-align: center;
            margin-top: 2rem;
            padding: 20px;
            color: var(--dark);
            opacity: 0.7;
        }
        .map-btn, .fav-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.8em;
            margin-right: 8px;
            cursor: pointer;
        }
        .map-btn {
            background: var(--primary);
            color: white;
        }
        .fav-btn {
            background: var(--secondary);
            color: var(--dark);
        }
    </style>
</head>
<body>
    <header>
        <h1>EstateAI Advisor</h1>
        <p>AI-Powered Real Estate Guidance for Kenya</p>
    </header>
    
    <div class="container">
        <div class="features">
            <!-- Chatbot Feature -->
            <div class="card">
                <h2>AI Property Advisor</h2>
                <p>Ask about properties, investments, or area insights in natural language</p>
                <div class="chat-container">
                    <div id="chat-messages">
                        <div class="message bot-message">Hello! I'm your EstateAI advisor. How can I help you with Kenyan real estate today?</div>
                    </div>
                    <div id="chat-input">
                        <input type="text" id="user-input" placeholder="e.g., Show me 3-bedroom houses in Westlands under 20M">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
            
            <!-- Prediction Feature -->
            <div class="card">
                <h2>Investment Feasibility</h2>
                <p>Premium feature: Get compatibility scores for your property choices</p>
                <form id="prediction-form">
                    <input type="number" id="budget" placeholder="Budget (KES)" min="1000000" required>
                    <input type="number" id="family-size" placeholder="Family Size" min="1" max="10" required>
                    <input type="text" id="location" placeholder="Location (e.g., Nairobi Westlands)" required>
                    <button type="submit">Get Prediction</button>
                    <span class="premium-badge">PREMIUM</span>
                </form>
                <div id="prediction-result"></div>
            </div>
            
            <!-- Virtual Furnishing -->
            <div class="card">
                <h2>Virtual Furnishing</h2>
                <p>Upload a room photo to visualize furniture placement</p>
                <form id="furnish-form" class="upload-form">
                    <input type="file" id="room-image" accept="image/*" required>
                    <select id="furniture-type">
                        <option value="sofa">Sofa</option>
                        <option value="bed">Bed</option>
                        <option value="dining_table">Dining Table</option>
                    </select>
                    <button type="submit">Furnish Room</button>
                </form>
                <div id="furnish-result"></div>
            </div>
        </div>
        
        <div class="card">
            <h2>Property Listings</h2>
            <div id="property-listings">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>
    
    <!-- Map Modal -->
    <div id="map-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; width:90%; max-width:800px; height:80%; border-radius:10px; overflow:hidden; position:relative;">
            <button onclick="closeMap()" style="position:absolute; top:10px; right:15px; background:#e76f51; color:white; border:none; width:30px; height:30px; border-radius:50%; font-weight:bold; cursor:pointer;">×</button>
            <div id="property-map" style="width:100%; height:100%;"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha512-BwC8CqK7bK9FkVdJ2y8C8F6JZ6q3h5zqKfHkXpJg8m3nLZGcYR+eMvSsXaWVb9uEiOoNlDjT0QxQrPdJ3I3XJ8w4V0A=="
            crossorigin=""></script>

    <script>
        // ✅ Safe localStorage helper (works in sandboxed iframes)
        function createSafeStorage() {
            let memoryStore = {};
            try {
                const testKey = '__storage_test__';
                localStorage.setItem(testKey, testKey);
                localStorage.removeItem(testKey);
                return localStorage;
            } catch (e) {
                console.warn('localStorage unavailable. Using in-memory fallback.');
                return {
                    getItem: (key) => memoryStore[key] || null,
                    setItem: (key, value) => { memoryStore[key] = String(value); },
                    removeItem: (key) => delete memoryStore[key],
                    clear: () => { memoryStore = {}; }
                };
            }
        }
        const safeStorage = createSafeStorage();

        // Initialize auth token (demo only)
        if (!safeStorage.getItem('token')) {
            safeStorage.setItem('token', 'demo_token');
        }

        // Helper to escape HTML
        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "<")
                .replace(/>/g, ">")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Leaflet map functions
        let currentMap = null;
        function showPropertyOnMap(property) {
            try {
                const mapContainer = document.getElementById('property-map');
                if (!mapContainer) return;
                
                mapContainer.innerHTML = '';
                
                currentMap = L.map(mapContainer).setView([property.lat, property.lng], 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(currentMap);
                
                L.marker([property.lat, property.lng]).addTo(currentMap)
                    .bindPopup(`<strong>${escapeHtml(property.title)}</strong><br>📍 ${escapeHtml(property.location)}`)
                    .openPopup();
                
                document.getElementById('map-modal').style.display = 'flex';
                
            } catch (e) {
                console.error('Map error:', e);
                alert('Unable to load map. Please try again.');
            }
        }

        function closeMap() {
            document.getElementById('map-modal').style.display = 'none';
            if (currentMap) {
                currentMap.remove();
                currentMap = null;
            }
        }

        // Favorites
        async function saveToFavorites(propId) {
            if (!propId) return;
            try {
                const response = await fetch(`/api/favorites/${propId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + safeStorage.getItem('token')
                    }
                });
                
                if (response.ok) {
                    alert('✅ Saved to favorites!');
                } else {
                    const err = await response.json();
                    alert('Error: ' + (err.detail || 'Could not save'));
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save. Please try again.');
            }
        }

        // Property listings
        async function showPropertyListings(criteria) {
            const messagesDiv = document.getElementById('chat-messages');
            
            try {
                // Use mock data for demo (replace with API call in real app)
                const mockProperties = [
                    {
                        id: 1,
                        title: "Cozy 1-Bed Apartment",
                        location: "Kamakwa, Nyeri",
                        price: 18000,
                        bedrooms: 1,
                        area_sqm: 45,
                        latitude: -0.4200,
                        longitude: 36.9500
                    },
                    {
                        id: 2,
                        title: "Modern Studio Flat",
                        location: "Kamakwa, Nyeri",
                        price: 15000,
                        bedrooms: 1,
                        area_sqm: 38,
                        latitude: -0.4210,
                        longitude: 36.9520
                    },
                    {
                        id: 3,
                        title: "2-Bed Family Apartment",
                        location: "Nyeri Town",
                        price: 25000,
                        bedrooms: 2,
                        area_sqm: 70,
                        latitude: -0.4150,
                        longitude: 36.9480
                    }
                ];
                
                let listingsHtml = `<div style="margin-top:10px; font-size:0.9em;"><strong>Matching Properties:</strong><ul>`;
                mockProperties.slice(0, 3).forEach(prop => {
                    const price = prop.price.toLocaleString();
                    const priceLabel = criteria.listing_type === 'rent' ? '/month' : '';
                    listingsHtml += `
                        <li style="margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #eee;">
                            <strong>${escapeHtml(prop.title)}</strong> – ${prop.bedrooms} bed, ${prop.area_sqm} sqm<br>
                            <em>KES ${price} ${priceLabel}</em><br>
                            <small>📍 ${escapeHtml(prop.location)}</small><br>
                            <div style="margin-top:8px;">
                                <button class="map-btn" onclick='showPropertyOnMap({
                                    lat: ${prop.latitude},
                                    lng: ${prop.longitude},
                                    title: "${escapeHtml(prop.title)}",
                                    location: "${escapeHtml(prop.location)}"
                                })'>View on Map</button>
                                <button class="fav-btn" onclick='saveToFavorites(${prop.id})'>❤️ Save</button>
                            </div>
                        </li>
                    `;
                });
                listingsHtml += `</ul></div>`;
                
                const listingsMsg = document.createElement('div');
                listingsMsg.className = 'message bot-message';
                listingsMsg.innerHTML = listingsHtml;
                messagesDiv.appendChild(listingsMsg);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
            } catch (error) {
                console.error('Listing fetch error:', error);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'message bot-message';
                errorMsg.textContent = 'Failed to load property listings.';
                messagesDiv.appendChild(errorMsg);
            }
        }

        // Chatbot
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (!message) return;
            
            const messagesDiv = document.getElementById('chat-messages');
            const userMsg = document.createElement('div');
            userMsg.className = 'message user-message';
            userMsg.textContent = message;
            messagesDiv.appendChild(userMsg);
            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            try {
                // Mock chatbot response (replace with API call in real app)
                const mockResponse = {
                    intent: "property_search",
                    response: "I found properties matching your criteria in Kamakwa! Would you like details?",
                    requires_action: true,
                    search_criteria: {
                        location: "Kamakwa, Nyeri",
                        bedrooms: 1,
                        listing_type: "rent"
                    }
                };
                
                const botMsg = document.createElement('div');
                botMsg.className = 'message bot-message';
                botMsg.textContent = mockResponse.response;
                messagesDiv.appendChild(botMsg);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                if (mockResponse.requires_action && mockResponse.search_criteria) {
                    showPropertyListings(mockResponse.search_criteria);
                }
                
            } catch (error) {
                console.error('Error:', error);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'message bot-message';
                errorMsg.textContent = 'Sorry, I encountered an error. Please try again.';
                messagesDiv.appendChild(errorMsg);
            }
        }

        // Load property listings on page load (mock)
        window.addEventListener('load', () => {
            const mockProperties = [
                {
                    id: 1,
                    title: "Cozy 1-Bed Apartment",
                    location: "Kamakwa, Nyeri",
                    price: 18000,
                    bedrooms: 1,
                    area_sqm: 45,
                    latitude: -0.4200,
                    longitude: 36.9500
                },
                {
                    id: 2,
                    title: "Westlands Luxury 3-Bed",
                    location: "Westlands, Nairobi",
                    price: 12000000,
                    bedrooms: 3,
                    area_sqm: 150,
                    latitude: -1.2600,
                    longitude: 36.8000
                }
            ];
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">';
            mockProperties.forEach(prop => {
                const price = prop.price.toLocaleString();
                html += `
                    <div class="product-card">
                        <h5>${prop.title}</h5>
                        <p><strong>Location:</strong> ${prop.location}</p>
                        <p><strong>Price:</strong> KES ${price} ${prop.price < 100000 ? '/month' : ''}</p>
                        <p><strong>Bedrooms:</strong> ${prop.bedrooms}</p>
                        <p><strong>Area:</strong> ${prop.area_sqm} sqm</p>
                        <button class="map-btn" onclick='showPropertyOnMap({
                            lat: ${prop.latitude},
                            lng: ${prop.longitude},
                            title: "${prop.title}",
                            location: "${prop.location}"
                        })'>View on Map</button>
                        <button class="fav-btn" onclick='saveToFavorites(${prop.id})'>❤️ Save</button>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('property-listings').innerHTML = html;
        });

        // Allow Enter key in chat
        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>